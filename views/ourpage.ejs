<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„ÇØ„Çª„ÇπËß£Êûê</title>
    <script defer src="/chartjs/chart.umd.js"></script>
    <link href="/output.css" rel="stylesheet">

</head>

<style>
    /* ËÉåÊôØËâ≤ */
body {
    background-color: #f8f9fa; /* Tailwind „ÅÆ bg-light Áõ∏ÂΩì */
}

/* „Ç≥„É≥„ÉÜ„Éä */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
}

/* „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ‰ΩôÁôΩ */
.mt-4 { margin-top: 16px; }
.mt-5 { margin-top: 24px; }

/* „ÉÜ„Ç≠„Çπ„ÉàÈñ¢ÈÄ£ */
.text-center { text-align: center; }
.text-primary { color: #007bff; }
.text-success { color: #28a745; }
.text-2xl { font-size: 24px; font-weight: bold; }
.text-lg { font-size: 18px; font-weight: bold; }
.fs-4 { font-size: 1.25rem; }

/* „Éï„É¨„ÉÉ„ÇØ„Çπ„Éú„ÉÉ„ÇØ„Çπ */
.flex { display: flex; }
.flex-wrap { flex-wrap: wrap; }

/* „Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ */
.card {
    background-color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

/* „ÉÜ„Éº„Éñ„É´„Çπ„Çø„Ç§„É´ */
.table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #dee2e6;
}

.table th, .table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: left;
}

.table-dark {
    background-color: #343a40;
    color: white;
}

/* „Éú„Çø„É≥ */
.btn {
    display: inline-block;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
    text-decoration: none;
    text-align: center;
    cursor: pointer;
}

.btn-primary {
    background-color: #007bff;
    color: white;
    border: none;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #a71d2a;
}

</style>

<body>

    <div class="container">
        <h2 class="text-center">„Ç¢„ÇØ„Çª„ÇπËß£Êûê</h2>

        <div class="flex-wrap">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">„Çµ„Éº„ÇØ„É´Êï∞</h5>
                    <p class="text-primary fs-4"><%= totalCircles || 0 %> ‰ª∂</p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞</h5>
                    <p class="text-success fs-4"><%= totalViews || 0 %> Âõû</p>
                </div>
            </div>
        </div>

        <!-- Êäò„ÇåÁ∑ö„Ç∞„É©„Éï -->
        <div class="mt-5">
            <h3 class="text-center">Êó•Âà•„Ç¢„ÇØ„Çª„ÇπÊï∞„ÅÆÊé®Áßª</h3>
            <canvas id="viewsChart"></canvas>
        </div>

        <!-- Êó•Âà•Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞„ÅÆË°® -->
        <div class="mt-5">
            <h3>Êó•Âà•„Ç¢„ÇØ„Çª„ÇπÊï∞</h3>
            <table class="table">
                <thead class="table-dark">
                    <tr>
                        <th>Êó•‰ªò (MM/DD)</th>
                        <th>Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (dailyViews.length > 0) { %>
                        <% dailyViews.forEach(view => { 
                            const date = new Date(view.viewDate);
                            const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                        %>
                            <tr>
                                <td><%= formattedDate %></td>
                                <td><%= view.totalViews %> Âõû</td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="2" class="text-center">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

    </div>

    <!-- „Çµ„Éº„ÇØ„É´‰∏ÄË¶ßË°® -->
    <div class="mt-5">
        <h3 class="text-center">„Çµ„Éº„ÇØ„É´‰∏ÄË¶ß</h3>
        <table class="table">
            <thead class="table-dark">
                <tr>
                    <th>„Çµ„Éº„ÇØ„É´Âêç</th>
                    <th>„Ç∏„É£„É≥„É´</th>
                    <th>Á∑èÈñ≤Ë¶ßÊï∞</th>
                    <th>ÁÆ°ÁêÜ</th>
                </tr>
            </thead>
            <tbody>
                <% if (circles.length > 0) { %>
                    <% circles.forEach(circle => { %>
                        <tr>
                            <td><%= circle.circleName %></td>
                            <td><%= circle.mainGenre %></td>
                            <td><%= circle.totalViews %> Âõû</td>
                            <td>
                                <a href="/circle/admin/<%= circle.id %>" class="btn btn-primary btn-sm">Á∑®ÈõÜ</a>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="4" class="text-center">„Çµ„Éº„ÇØ„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>



<script>
   

        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById("viewsChart").getContext("2d");
    
            // ‚úÖ HTML „Ç®„É≥„Ç≥„Éº„Éâ„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„Éá„Éº„Çø„ÇíÊ≠£„Åó„ÅèÊ∏°„Åô
            const dailyViews = <%- JSON.stringify(dailyViews) %>;
    
            console.log("‚úÖ dailyViews from EJS:", dailyViews);
    
            // üîπ Êó•‰ªò„Éá„Éº„Çø„Çí `MM/DD` ÂΩ¢Âºè„Å´Â§âÊèõ
            const labels = dailyViews.map(v => {
                const date = new Date(v.viewDate);
                const month = date.getMonth() + 1; // Êúà„ÅØ 0-indexedÔºà0 = 1Êúà, 1 = 2Êúà, ...Ôºâ
                const day = date.getDate();
                return `${month}/${day}`;
            });
    
            // üîπ ÂêÑÊó•„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊï∞„Éá„Éº„ÇøÔºà`totalViews`Ôºâ„ÇíÂèñÂæó
            const data = dailyViews.map(v => v.totalViews);
    
            console.log("‚úÖ labels:", labels);
            console.log("‚úÖ data:", data);
    
            if (labels.length === 0 || data.length === 0) {
                console.error("‚ùå „Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô„ÄÇ„Ç∞„É©„Éï„ÇíË°®Á§∫„Åß„Åç„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
    
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,  // `MM/DD` ÂΩ¢Âºè„ÅÆ„É©„Éô„É´
                    datasets: [{
                        label: "Êó•Âà•„Ç¢„ÇØ„Çª„ÇπÊï∞",
                        data: data,
                        borderColor: "rgba(75, 192, 192, 1)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Êó•‰ªò (MM/DD)" }
                        },
                        y: {
                            title: { display: true, text: "„Ç¢„ÇØ„Çª„ÇπÊï∞" },
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
    

</body>
</html>
