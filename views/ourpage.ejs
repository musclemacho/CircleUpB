<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„ÇØ„Çª„ÇπËß£Êûê</title>
    <script src="/js/chart.min.js"></script>

    <script src="/js/chart.min.js"></script>

</head>
<body class="bg-light">

    <div class="container mt-4">
        <h2 class="text-center">„Ç¢„ÇØ„Çª„ÇπËß£Êûê</h2>

        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">„Çµ„Éº„ÇØ„É´Êï∞</h5>
                        <p class="card-text text-primary fs-4"><%= totalCircles || 0 %> ‰ª∂</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞</h5>
                        <p class="card-text text-success fs-4"><%= totalViews || 0 %> Âõû</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êäò„ÇåÁ∑ö„Ç∞„É©„Éï -->
        <div class="mt-5">
            <h3 class="text-center">Êó•Âà•„Ç¢„ÇØ„Çª„ÇπÊï∞„ÅÆÊé®Áßª</h3>
            <canvas id="viewsChart"></canvas>
        </div>

        <!-- Êó•Âà•Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞„ÅÆË°® -->
        <div class="mt-5">
            <h3>Êó•Âà•„Ç¢„ÇØ„Çª„ÇπÊï∞</h3>
            <table class="table table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Êó•‰ªò (MM/DD)</th>
                        <th>Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (dailyViews.length > 0) { %>
                        <% dailyViews.forEach(view => { 
                            const date = new Date(view.viewDate);
                            const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                        %>
                            <tr>
                                <td><%= formattedDate %></td>
                                <td><%= view.totalViews %> Âõû</td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="2" class="text-center">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td>
                        </tr>
                    <% } %>
                </tbody>
                
            </table>
        </div>

    </div>

    <!-- „Çµ„Éº„ÇØ„É´‰∏ÄË¶ßË°® -->
<div class="mt-5">
    <h3 class="text-center">„Çµ„Éº„ÇØ„É´‰∏ÄË¶ß</h3>
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>„Çµ„Éº„ÇØ„É´Âêç</th>
                <th>„Ç∏„É£„É≥„É´</th>
                <th>Á∑èÈñ≤Ë¶ßÊï∞</th>
                <th>ÁÆ°ÁêÜ</th>
            </tr>
        </thead>
        <tbody>
            <% if (circles.length > 0) { %>
                <% circles.forEach(circle => { %>
                    <tr>
                        <td><%= circle.circleName %></td>
                        <td><%= circle.mainGenre %></td>
                        <td><%= circle.totalViews %> Âõû</td>
                        <td>
                            <a href="/circle/admin/<%= circle.id %>" class="btn btn-primary btn-sm">Á∑®ÈõÜ</a>
                            <!-- <button class="btn btn-danger btn-sm" onclick="deleteCircle(<%= circle.id %>)">ÂâäÈô§</button> -->
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="4" class="text-center">„Çµ„Éº„ÇØ„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- ÂâäÈô§„Éú„Çø„É≥„ÅÆ JavaScript -->
<script>
    function deleteCircle(circleId) {
        if (confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
            fetch(`/circle/delete/${circleId}`, { method: "DELETE" })
                .then(response => {
                    if (response.ok) {
                        alert("„Çµ„Éº„ÇØ„É´„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºÅ");
                        location.reload();
                    } else {
                        alert("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                    }
                });
        }
    }


    
        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById("viewsChart").getContext("2d");
    
            // ‚úÖ HTML „Ç®„É≥„Ç≥„Éº„Éâ„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„Éá„Éº„Çø„ÇíÊ≠£„Åó„ÅèÊ∏°„Åô
            const dailyViews = <%- JSON.stringify(dailyViews) %>;
    
            console.log("‚úÖ dailyViews from EJS:", dailyViews);
    
            // üîπ Êó•‰ªò„Éá„Éº„Çø„Çí `MM/DD` ÂΩ¢Âºè„Å´Â§âÊèõ
            const labels = dailyViews.map(v => {
                const date = new Date(v.viewDate);
                const month = date.getMonth() + 1; // Êúà„ÅØ 0-indexedÔºà0 = 1Êúà, 1 = 2Êúà, ...Ôºâ
                const day = date.getDate();
                return `${month}/${day}`;
            });
    
            // üîπ ÂêÑÊó•„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊï∞„Éá„Éº„ÇøÔºà`totalViews`Ôºâ„ÇíÂèñÂæó
            const data = dailyViews.map(v => v.totalViews);
    
            console.log("‚úÖ labels:", labels);
            console.log("‚úÖ data:", data);
    
            if (labels.length === 0 || data.length === 0) {
                console.error("‚ùå „Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô„ÄÇ„Ç∞„É©„Éï„ÇíË°®Á§∫„Åß„Åç„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
    
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,  // `MM/DD` ÂΩ¢Âºè„ÅÆ„É©„Éô„É´
                    datasets: [{
                        label: "Êó•Âà•„Ç¢„ÇØ„Çª„ÇπÊï∞",
                        data: data,
                        borderColor: "rgba(75, 192, 192, 1)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Êó•‰ªò (MM/DD)" }
                        },
                        y: {
                            title: { display: true, text: "„Ç¢„ÇØ„Çª„ÇπÊï∞" },
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
    

</body>
</html>
