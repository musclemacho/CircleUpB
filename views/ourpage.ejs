<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ã‚¯ã‚»ã‚¹è§£æ</title>
    <script defer src="/chartjs/chart.umd.js"></script>
    <link href="/output.css" rel="stylesheet">

</head>

<style>
    /* èƒŒæ™¯è‰² */
body {
    background-color: #f8f9fa; /* Tailwind ã® bg-light ç›¸å½“ */
}

/* ã‚³ãƒ³ãƒ†ãƒŠ */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä½™ç™½ */
.mt-4 { margin-top: 16px; }
.mt-5 { margin-top: 24px; }

/* ãƒ†ã‚­ã‚¹ãƒˆé–¢é€£ */
.text-center { text-align: center; }
.text-primary { color: #007bff; }
.text-success { color: #28a745; }
.text-2xl { font-size: 24px; font-weight: bold; }
.text-lg { font-size: 18px; font-weight: bold; }
.fs-4 { font-size: 1.25rem; }

/* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ */
.flex { display: flex; }
.flex-wrap { flex-wrap: wrap; }

/* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.card {
    background-color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #dee2e6;
}

.table th, .table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: left;
}

.table-dark {
    background-color: #343a40;
    color: white;
}

/* ãƒœã‚¿ãƒ³ */
.btn {
    display: inline-block;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
    text-decoration: none;
    text-align: center;
    cursor: pointer;
}

.btn-primary {
    background-color: #007bff;
    color: white;
    border: none;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #a71d2a;
}

</style>

<body>

    <div class="container">
        <h2 class="text-center">ã‚¢ã‚¯ã‚»ã‚¹è§£æ</h2>

        <div class="flex-wrap">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ã‚µãƒ¼ã‚¯ãƒ«æ•°</h5>
                    <p class="text-primary fs-4"><%= totalCircles || 0 %> ä»¶</p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ç·ã‚¢ã‚¯ã‚»ã‚¹æ•°</h5>
                    <p class="text-success fs-4"><%= totalViews || 0 %> å›</p>
                </div>
            </div>
        </div>

        <!-- æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
        <div class="mt-5">
            <h3 class="text-center">æ—¥åˆ¥ã‚¢ã‚¯ã‚»ã‚¹æ•°ã®æ¨ç§»</h3>
            <canvas id="viewsChart"></canvas>
        </div>

        <!-- æ—¥åˆ¥ç·ã‚¢ã‚¯ã‚»ã‚¹æ•°ã®è¡¨ -->
        <div class="mt-5">
            <h3>æ—¥åˆ¥ã‚¢ã‚¯ã‚»ã‚¹æ•°</h3>
            <table class="table">
                <thead class="table-dark">
                    <tr>
                        <th>æ—¥ä»˜ (MM/DD)</th>
                        <th>ç·ã‚¢ã‚¯ã‚»ã‚¹æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (dailyViews.length > 0) { %>
                        <% dailyViews.forEach(view => { 
                            const date = new Date(view.viewDate);
                            const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                        %>
                            <tr>
                                <td><%= formattedDate %></td>
                                <td><%= view.totalViews %> å›</td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="2" class="text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

    </div>

    <!-- ã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§è¡¨ -->
    <div class="mt-5">
        <h3 class="text-center">ã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§</h3>
        <table class="table">
            <thead class="table-dark">
                <tr>
                    <th>ã‚µãƒ¼ã‚¯ãƒ«å</th>
                    <th>ã‚¸ãƒ£ãƒ³ãƒ«</th>
                    <th>ç·é–²è¦§æ•°</th>
                    <th>ç®¡ç†</th>
                </tr>
            </thead>
            <tbody>
                <% if (circles.length > 0) { %>
                    <% circles.forEach(circle => { %>
                        <tr>
                            <td><%= circle.circleName %></td>
                            <td><%= circle.mainGenre %></td>
                            <td><%= circle.totalViews %> å›</td>
                            <td>
                                <a href="/circle/admin/<%= circle.id %>" class="btn btn-primary btn-sm">ç·¨é›†</a>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="4" class="text-center">ã‚µãƒ¼ã‚¯ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>
<!-- ğŸ”¹ ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ãƒœã‚¿ãƒ³ -->
<div class="mt-5 text-center">
    <button id="clearCacheBtn" class="btn btn-danger">ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤</button>
    <p id="cacheClearMessage" class="text-success mt-2" style="display: none;">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼</p>
</div>

<script>
    document.getElementById("clearCacheBtn").addEventListener("click", function () {
      

        fetch("/delete-cache", { method: "POST" })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("cacheClearMessage").style.display = "block";
                } else {
                    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + data.error);
                }
            })
            .catch(error => {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error);
            });
    });

        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById("viewsChart").getContext("2d");
    
            // âœ… HTML ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ¸¡ã™
            const dailyViews = <%- JSON.stringify(dailyViews) %>;
    
            console.log("âœ… dailyViews from EJS:", dailyViews);
    
            // ğŸ”¹ æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ `MM/DD` å½¢å¼ã«å¤‰æ›
            const labels = dailyViews.map(v => {
                const date = new Date(v.viewDate);
                const month = date.getMonth() + 1; // æœˆã¯ 0-indexedï¼ˆ0 = 1æœˆ, 1 = 2æœˆ, ...ï¼‰
                const day = date.getDate();
                return `${month}/${day}`;
            });
    
            // ğŸ”¹ å„æ—¥ã®ã‚¢ã‚¯ã‚»ã‚¹æ•°ãƒ‡ãƒ¼ã‚¿ï¼ˆ`totalViews`ï¼‰ã‚’å–å¾—
            const data = dailyViews.map(v => v.totalViews);
    
            console.log("âœ… labels:", labels);
            console.log("âœ… data:", data);
    
            if (labels.length === 0 || data.length === 0) {
                console.error("âŒ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚");
                return;
            }
    
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,  // `MM/DD` å½¢å¼ã®ãƒ©ãƒ™ãƒ«
                    datasets: [{
                        label: "æ—¥åˆ¥ã‚¢ã‚¯ã‚»ã‚¹æ•°",
                        data: data,
                        borderColor: "rgba(75, 192, 192, 1)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "æ—¥ä»˜ (MM/DD)" }
                        },
                        y: {
                            title: { display: true, text: "ã‚¢ã‚¯ã‚»ã‚¹æ•°" },
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
    

</body>
</html>
